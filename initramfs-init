#!/bin/sh
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs devtmpfs /dev

modprobe xhci-hcd
modprobe usb-storage
modprobe sd_mod
modprobe ext4

ROOT=$(sed -n 's/.*root=\([^ ]*\).*/\1/p' /proc/cmdline)
echo "Trying to mount root from $ROOT_DEV"

case "$ROOT" in
    UUID=*)  ROOT="/dev/disk/by-uuid/${ROOT#UUID=}" ;;
    LABEL=*) ROOT="/dev/disk/by-label/${ROOT#LABEL=}" ;;
esac

echo "Waiting for root device $ROOT..."
TIMER=0
while [ ! -b "$ROOT" ] && [ $TIMER -lt 10 ]; do
    sleep 1
    TIMER=$((TIMER + 1))
done

if [ -b "$ROOT" ]; then
    echo "Mounting $ROOT..."
    mkdir -p /newroot
    mount -o ro "$ROOT" /newroot  # Mount as read-only initially

    echo "Switching to real root..."
    exec switch_root /newroot /sbin/init
else
    echo "ERROR: Root device $ROOT not found!"
    echo "Dropping to recovery shell..."
    echo
    echo "Welcome to RISC-V Linux!"
    mkdir -p /mnt/host
    mount -t 9p -o trans=virtio,version=9p2000.L hostshare /mnt/host || true
    exec setsid cttyhack sh
fi

